<!DOCTYPE HTML>
<html>
  <head>
    <meta chartset="utf-8" />
    <script type="text/javascript">
    // var ws = new WebSocket("ws://localhost:4000/socket/websocket");
    var ws = new WebSocket("ws://salty-taiga-73405.herokuapp.com/socket/websocket");

    function WebSocketSetup(chat)
    {
      ws.onopen = function() {
        var data = {
          topic: "rooms:lobby",
          event: "phx_join",
          payload: {
            user: message
          },
          ref: 1
        };

        ws.send(JSON.stringify(data));
      };

      ws.onmessage = function (evt) {
        data = JSON.parse(evt.data);

        switch (data.event) {
          case "phx_reply": // ?

            break;
          case "user:entered": // broadcasted to all subscribers
            chat.innerHTML += "<br />User entered chat!";
            // console.log(data.event);
            break;
          case "phx_join":
            // user entered chat successfully, for that user only
            break;

          case "phx_error": //?
            break;
          case "new:message":
            console.log(data.payload);
            publishMessage(chat, data.payload);
            break;
          default:
            console.log("Missed: " + data.event);
            // user leave chat?
        }
      };

      ws.onclose = function() {
        chat.innerHTML += "<br />User left chat...";
      };
    }

    function sendMessage(message)
    {
      var longitude, latitude, data;

      // navigator.geolocation.getCurrentPosition(function (position) {
      //   longitude = position.coords.longitude;
      //   latitude = position.coords.latitude;
      //   console.log(longitude, latitude);
      // });

      data = {
        topic: "rooms:lobby",
        event: "new:message",
        payload: {
          user_id: 1,
          chat_room_id: 11,
          message: message
        },
        ref: 1
      };

      ws.send(JSON.stringify(data));
    }

    function publishMessage(chat, payload)
    {
      chat.innerHTML += "<br />" + payload.user_id + ": " + payload.body;
    }

    window.addEventListener('load', function(e) {
      var chat = document.getElementById('chat'),
          message = document.getElementById('message');

      WebSocketSetup(chat);

      message.addEventListener('keyup', function (e) {
        if (e.keyCode == 13) {
          sendMessage(message.value);
          message.value = '';
        }
      });
    });
    </script>
  </head>
  <body>
    <div id="chat">
    </div>
    <input type="text" id="message" autocomplete="off" />
  </body>
</html>